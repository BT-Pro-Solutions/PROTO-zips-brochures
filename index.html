<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brochures - Carriers, Wreckers, Trucks & Trailers</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        Header Placeholder
    </header>
    <div class="brochures-tabs">
        <a href="#" class="tab-item active" data-tab="equipment">
            Equipment Brochures
        </a>
        <a href="#" class="tab-item" data-tab="product">
            Product Brochures
        </a>
    </div>

    <div class="content-wrapper">
        <div class="tab-content">
            <div id="equipment-content" class="tab-panel active">
                <div class="brochures-container">
                    <div class="loading">Loading equipment brochures...</div>
                </div>
            </div>
            <div id="product-content" class="tab-panel">
                <div class="brochures-container">
                    <div class="loading">Loading product brochures...</div>
                </div>
            </div>
        </div>
        
        <div class="alphabet-nav" id="alphabet-nav">
            <!-- Alphabet letters will be generated by JavaScript -->
        </div>
    </div>

    <script>
        class BrochureManager {
            constructor() {
                this.data = null;
                this.activeTab = 'equipment';
                this.brandPositions = {}; // Store brand positions for alphabet nav
                this.availableLetters = new Set(); // Store available first letters
                this.observer = null; // Intersection observer
                this.userClickedLetter = false; // Track if user clicked a letter
                this.scrollTimeout = null; // Debounce scroll events
                this.isScrollingToLetter = false; // Track programmatic scrolling
                this.init();
            }

            async init() {
                try {
                    await this.loadData();
                    this.setupTabs();
                    this.createAlphabetNav();
                    this.renderContent();
                    this.updateAlphabetAvailability();
                    this.setupScrollObserver();
                    this.setupScrollDetection();
                } catch (error) {
                    console.error('Failed to initialize brochure manager:', error);
                    this.showError('Failed to load brochure data');
                }
            }

            async loadData() {
                try {
                    const response = await fetch('brochures_data.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    this.data = await response.json();
                } catch (error) {
                    console.error('Error loading brochure data:', error);
                    throw error;
                }
            }

            setupTabs() {
                const tabItems = document.querySelectorAll('.tab-item');
                tabItems.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabType = tab.getAttribute('data-tab');
                        this.switchTab(tabType);
                    });
                });
            }

            switchTab(tabType) {
                // Update active tab
                this.activeTab = tabType;
                
                // Update tab appearance
                document.querySelectorAll('.tab-item').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabType}"]`).classList.add('active');
                
                // Update content visibility
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById(`${tabType}-content`).classList.add('active');
                
                // Clear active alphabet letter state when switching tabs
                document.querySelectorAll('.alphabet-letter').forEach(el => {
                    el.classList.remove('active');
                });
                
                // Reset user interaction flags
                this.userClickedLetter = false;
                this.isScrollingToLetter = false;
                
                // Update alphabet navigation availability
                this.updateAlphabetAvailability();
                
                // Re-observe brand sections for new tab
                setTimeout(() => {
                    this.observeBrandSections();
                    this.updateActiveLetterFromObserver();
                }, 100);
            }

            createAlphabetNav() {
                const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
                const alphabetNav = document.getElementById('alphabet-nav');
                
                alphabetNav.innerHTML = '';
                
                alphabet.forEach(letter => {
                    const letterElement = document.createElement('div');
                    letterElement.className = 'alphabet-letter';
                    letterElement.textContent = letter;
                    letterElement.setAttribute('data-letter', letter);
                    
                    letterElement.addEventListener('click', () => {
                        this.scrollToLetter(letter);
                    });
                    
                    alphabetNav.appendChild(letterElement);
                });
            }

            updateAlphabetAvailability() {
                if (!this.data) return;
                
                // Get current tab's brands
                const currentBrands = this.activeTab === 'equipment' 
                    ? this.data.equipmentBrochures 
                    : this.data.productBrochures;
                
                // Clear previous available letters
                this.availableLetters.clear();
                
                // Find available first letters
                Object.keys(currentBrands).forEach(brandName => {
                    const firstLetter = brandName.charAt(0).toUpperCase();
                    this.availableLetters.add(firstLetter);
                });
                
                // Update alphabet navigation
                document.querySelectorAll('.alphabet-letter').forEach(letterEl => {
                    const letter = letterEl.getAttribute('data-letter');
                    letterEl.classList.remove('available', 'unavailable');
                    
                    if (this.availableLetters.has(letter)) {
                        letterEl.classList.add('available');
                    } else {
                        letterEl.classList.add('unavailable');
                    }
                });
            }

            setupScrollDetection() {
                // Listen for manual scroll events
                window.addEventListener('scroll', () => {
                    // Clear any existing timeout
                    if (this.scrollTimeout) {
                        clearTimeout(this.scrollTimeout);
                    }
                    
                    // If this is programmatic scrolling from letter click, ignore
                    if (this.isScrollingToLetter) {
                        return;
                    }
                    
                    // Mark that user has manually scrolled
                    this.userClickedLetter = false;
                    
                    // Debounce: clear active letter after scroll stops
                    this.scrollTimeout = setTimeout(() => {
                        if (!this.userClickedLetter && !this.isScrollingToLetter) {
                            // Let the intersection observer take over
                            this.updateActiveLetterFromObserver();
                        }
                    }, 150);
                }, { passive: true });
            }

            setupScrollObserver() {
                // Create intersection observer for brand sections
                const options = {
                    root: null,
                    rootMargin: '-80px 0px -50% 0px', // Account for sticky header
                    threshold: 0.1
                };

                this.observer = new IntersectionObserver((entries) => {
                    if (this.userClickedLetter || this.isScrollingToLetter) {
                        return; // Don't override user's letter selection
                    }
                    
                    // Find the most visible brand section
                    let mostVisible = null;
                    let maxVisibilityRatio = 0;
                    
                    entries.forEach(entry => {
                        if (entry.isIntersecting && entry.intersectionRatio > maxVisibilityRatio) {
                            mostVisible = entry.target;
                            maxVisibilityRatio = entry.intersectionRatio;
                        }
                    });
                    
                    if (mostVisible) {
                        const letter = mostVisible.getAttribute('data-brand-letter');
                        if (letter) {
                            this.updateActiveAlphabetLetter(letter);
                        }
                    }
                }, options);
            }

            updateActiveLetterFromObserver() {
                // Force the observer to check current visibility
                const activeContainer = document.querySelector(`#${this.activeTab}-content .brochures-container`);
                if (!activeContainer) return;
                
                const brandSections = activeContainer.querySelectorAll('[data-brand-letter]');
                let currentLetter = null;
                
                // Find which section is most visible
                brandSections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const tabHeight = 59; // Height of sticky tab bar
                    
                    // Check if section is in the upper part of viewport
                    if (rect.top <= tabHeight + 100 && rect.bottom > tabHeight + 50) {
                        currentLetter = section.getAttribute('data-brand-letter');
                    }
                });
                
                if (currentLetter) {
                    this.updateActiveAlphabetLetter(currentLetter);
                }
            }

            observeBrandSections() {
                // Clear previous observations
                if (this.observer) {
                    this.observer.disconnect();
                }
                
                // Observe brand sections in active tab
                const activeContainer = document.querySelector(`#${this.activeTab}-content .brochures-container`);
                if (!activeContainer) return;
                
                const brandSections = activeContainer.querySelectorAll('[data-brand-letter]');
                brandSections.forEach(section => {
                    this.observer.observe(section);
                });
            }

            scrollToLetter(targetLetter) {
                // Mark that this is a user-initiated scroll
                this.userClickedLetter = true;
                this.isScrollingToLetter = true;
                
                // Get the active tab container to scope our search
                const activeTabContainer = document.querySelector(`#${this.activeTab}-content .brochures-container`);
                if (!activeTabContainer) return;
                
                // If the letter is available, scroll to it directly
                if (this.availableLetters.has(targetLetter)) {
                    const element = activeTabContainer.querySelector(`[data-brand-letter="${targetLetter}"]`);
                    if (element) {
                        element.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        this.updateActiveAlphabetLetter(targetLetter);
                        
                        // Reset scrolling flag after animation
                        setTimeout(() => {
                            this.isScrollingToLetter = false;
                        }, 1000);
                        return;
                    }
                }
                
                // Find the nearest available letter
                const availableLettersArray = Array.from(this.availableLetters).sort();
                let nearestLetter = null;
                
                for (const letter of availableLettersArray) {
                    if (letter >= targetLetter) {
                        nearestLetter = letter;
                        break;
                    }
                }
                
                // If no letter found after target, use the last available letter
                if (!nearestLetter && availableLettersArray.length > 0) {
                    nearestLetter = availableLettersArray[availableLettersArray.length - 1];
                }
                
                if (nearestLetter) {
                    const element = activeTabContainer.querySelector(`[data-brand-letter="${nearestLetter}"]`);
                    if (element) {
                        element.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'start' 
                        });
                        this.updateActiveAlphabetLetter(nearestLetter);
                        
                        // Reset scrolling flag after animation
                        setTimeout(() => {
                            this.isScrollingToLetter = false;
                        }, 1000);
                    }
                }
            }

            updateActiveAlphabetLetter(letter) {
                document.querySelectorAll('.alphabet-letter').forEach(el => {
                    el.classList.remove('active');
                });
                
                const activeLetterEl = document.querySelector(`[data-letter="${letter}"]`);
                if (activeLetterEl) {
                    activeLetterEl.classList.add('active');
                }
            }

            renderContent() {
                if (!this.data) return;

                this.renderEquipmentBrochures();
                this.renderProductBrochures();
                
                // Set up observers after content is rendered
                setTimeout(() => {
                    this.observeBrandSections();
                }, 100);
            }

            renderEquipmentBrochures() {
                const container = document.querySelector('#equipment-content .brochures-container');
                const brands = this.data.equipmentBrochures;
                
                let html = '';
                
                // Sort brands alphabetically
                const sortedBrands = Object.keys(brands).sort();
                
                sortedBrands.forEach(brandName => {
                    const brochures = brands[brandName];
                    const firstLetter = brandName.charAt(0).toUpperCase();
                    html += this.createBrandSection(brandName, brochures, firstLetter);
                });
                
                container.innerHTML = html;
            }

            renderProductBrochures() {
                const container = document.querySelector('#product-content .brochures-container');
                const brands = this.data.productBrochures;
                
                let html = '';
                
                // Sort brands alphabetically
                const sortedBrands = Object.keys(brands).sort();
                
                sortedBrands.forEach(brandName => {
                    const brochures = brands[brandName];
                    const firstLetter = brandName.charAt(0).toUpperCase();
                    html += this.createBrandSection(brandName, brochures, firstLetter);
                });
                
                container.innerHTML = html;
            }

            createBrandSection(brandName, brochures, firstLetter) {
                let html = `
                    <div class="brochures-group" data-brand-letter="${firstLetter}">
                        <h2>${this.escapeHtml(brandName)} <span class="brochure-count">(${brochures.length})</span></h2>
                        <div class="brochures-list">
                `;
                
                brochures.forEach(brochure => {
                    html += `
                        <a href="${this.escapeHtml(brochure.url)}" target="_blank" class="brochure-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 4a2 2 0 0 1 2-2h8a1 1 0 0 1 .707.293l5 5A1 1 0 0 1 20 8v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4zm13.586 4L14 4.414V8h3.586zM12 4H6v16h12V10h-5a1 1 0 0 1-1-1V4zm0 7.5a1 1 0 0 1 1 1v2.586l.293-.293a1 1 0 0 1 1.414 1.414l-2 2a1 1 0 0 1-1.414 0l-2-2a1 1 0 1 1 1.414-1.414l.293.293V12.5a1 1 0 0 1 1-1z" fill="currentColor"/></svg>
                            ${this.escapeHtml(brochure.title)}
                        </a>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                return html;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                const containers = document.querySelectorAll('.brochures-container');
                containers.forEach(container => {
                    container.innerHTML = `
                        <div class="error-message">
                            <h3>Error</h3>
                            <p>${message}</p>
                            <p>Please check the console for more details.</p>
                        </div>
                    `;
                });
            }
        }

        // Initialize the brochure manager when the DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new BrochureManager();
        });
    </script>
</body>
</html>
